{"createdAt":"2025-05-28T19:16:58.139Z","updatedAt":"2025-06-20T00:07:15.639Z","id":"b4vhzzizmE8Wih1a","name":"Agente de IA BASE - teste","active":false,"isArchived":false,"nodes":[{"parameters":{"options":{}},"id":"42ef2ef5-3fab-490e-a46e-185a2c957940","name":"OpenAI Chat Model1","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[3200,1980]},{"parameters":{"model":"text-embedding-3-small","options":{}},"id":"5e9a8415-2d96-4dde-bd54-6a04d5e1498d","name":"Embeddings OpenAI","type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1,"position":[2640,2040]},{"parameters":{"content":"# Agente IA","height":80,"width":196,"color":5},"id":"ab4c69b7-fb59-43f8-b853-7bf0e48f29b3","name":"Sticky Note2","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[3480,1600]},{"parameters":{"tableName":{"__rl":true,"value":"documents","mode":"list","cachedResultName":"documents"},"options":{"queryName":"match_documents"}},"id":"825876b7-e9b1-42b9-b831-502ea07a0944","name":"Supabase Vector Store","type":"@n8n/n8n-nodes-langchain.vectorStoreSupabase","typeVersion":1,"position":[2820,2000]},{"parameters":{"content":"","height":620,"width":820,"color":4},"type":"n8n-nodes-base.stickyNote","position":[3460,1580],"typeVersion":1,"id":"64038391-533a-4b5f-b8b9-625540d32bc7","name":"Sticky Note4"},{"parameters":{"model":"gpt-4.1-mini","options":{}},"id":"0bb533f0-841e-4964-9edd-d4802111e77b","name":"OpenAI3","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[4440,2060]},{"parameters":{"options":{}},"id":"3d3d8a1f-b698-4e73-8a68-8818a0910e71","name":"Loop Over Items3","type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[5040,1880]},{"parameters":{"schemaType":"manual","inputSchema":"{\n  \"type\": \"object\",\n  \"properties\": {\n    \"messages\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"string\"\n      }\n    }\n  },\n  \"required\": [\"messages\"]\n}"},"id":"4a2dae01-ce17-49bb-8136-bbcbf85576a4","name":"OutputParser1","type":"@n8n/n8n-nodes-langchain.outputParserStructured","typeVersion":1.2,"position":[4660,2060]},{"parameters":{"promptType":"define","text":"=Whatsapp message to be splitted and formated: {{ $json.output }}","hasOutputParser":true,"messages":{"messageValues":[{"message":"={\n  \"messages\": [\n    \"Por favor, gere a sa√≠da no seguinte formato JSON: {\\\"messages\\\": [\\\"splitedMessage\\\", \\\"splitedMessage\\\", \\\"splitedMessage\\\"]}\",\n    \"As mensagens devem ser divididas de forma natural, afinal estamos conversando com um humano. Certifique-se de que a resposta siga exatamente essa estrutura, incluindo os colchetes e as aspas.\",\n    \"Jamais separe uma mensagem vazia. Cada mensagem deve ter entre 300 e 500 caracteres, sem cortar informa√ß√µes, pois √© uma conversa de chat.\",\n    \"Certifique-se de que a resposta siga exatamente essa estrutura: *negrito* (substitua '**' por '*') n√£o made nada em negrito remova todos '*'; ~tachado~ (caso seja algo exclu√≠do/alterado); _it√°lico_ (extremamente raro).\",\n    \"Tudo o que for link, pode colocar entre \\\"`\\\", ou seja, na seguinte formata√ß√£o: `www.link.com.br`. Use sempre essa formata√ß√£o para todos os links.\",\n\"troque essas palavra: Prazer por: feliz em conhecer\"\n  ]\n}"}]}},"id":"c8961d12-df32-4b58-b3cb-90e14e9c8c39","name":"Parser  Chain","type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.4,"position":[4460,1860]},{"parameters":{"content":"","height":620,"width":1380,"color":4},"type":"n8n-nodes-base.stickyNote","position":[4320,1580],"typeVersion":1,"id":"bbac6e2c-f9f9-4a14-a5e0-f17f0a22faeb","name":"Sticky Note18"},{"parameters":{"content":"# Divis√£o de Mensagens Inteligente - Texto","height":80,"width":736,"color":5},"id":"1b4d4719-18e0-42f4-85d5-bfee453ef02f","name":"Sticky Note19","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[4340,1600]},{"parameters":{"model":"gpt-4.1-mini","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[3520,1960],"id":"41833c09-0d21-4bd5-a214-acaba72e7b33","name":"OpenAI Chat Model"},{"parameters":{"promptType":"define","text":"={{ $('Mensagem Completa').item.json.mensagem_completa }}","options":{"systemMessage":"={\n  \"name\": \"Amanda\",\n  \"context\": {\n    \"identity\": \"Consultora Comercial de Vendas\",\n    \"business\": \"Fluxo Atendimento por IA para Terapeutas\",\n    \"Language\": \"portugu√™s brasileiro\",\n    \"date\": \"{{ $now.weekdayLong }}, {{ $now.format('dd/MM/yyyy') }}, {{ $now.hour.toString().padStart(2, '0') }}:{{ $now.minute.toString().padStart(2, '0') }}\"\n  },\n  \"Informa√ß√£o atualizada para usar em resposta\": \"{{ $json.output }}\",\n  \"personality\": [\n    \"Fala simples, objetiva e amig√°vel\",\n    \"Tono de voz educado e consultivo\",\n    \"N√£o usa emojis\",\n    \"Fala de forma personalizada, chamando pelo nome se souber\",\n    \"Faz uma pergunta por vez para manter o foco\",\n    \"Cria leve senso de urg√™ncia para agendamento\",\n    \"Refor√ßa benef√≠cios de forma pr√°tica\"\n  ],\n  \"objectives\": [\n    \"Apresentar a solu√ß√£o de atendimento por IA no WhatsApp para terapeutas\",\n    \"Agendar uma reuni√£o comercial com o terapeuta no hor√°rio comercial\"\n  ],\n  \"general_rules\": [\n    \"Atender apenas terapeutas e profissionais da √°rea emocional\",\n    \"Refor√ßar que as reuni√µes s√£o online, r√°pidas e 100% focadas na necessidade do terapeuta\",\n    \"Agendar reuni√µes somente de segunda a sexta-feira em hor√°rio comercial\",\n    \"Caso pe√ßam algo fora do fluxo, gentilmente redirecionar para o agendamento de reuni√£o\",\n    \"Nunca prometer pre√ßo ou condi√ß√µes comerciais sem a reuni√£o\",\n    \"Se a pessoa pedir para falar direto com um humano, informar que a reuni√£o √© o caminho para atendimento personalizado\",\n    \"Evitar termos t√©cnicos como 'chatbot' ou 'automa√ß√£o' e usar sempre 'atendimento inteligente por IA', refor√ßando que o atendimento √© como de uma secret√°ria e n√£o automatizado para agendamentos\",\n    \"Palavras proibidas: rob√¥, autom√°tico, chatbot, gr√°tis\"\n  ],\n  \"flow\": {\n    \"steps\": [\n      {\n        \"step\": \"Perguntar o nome\",\n        \"instructions\": \"Se apresentar e perguntar o nome da pessoa antes de prosseguir\",\n        \"example_message\": \"Ol√°! Meu nome √© Amanda, fa√ßo parte da equipe da Fluxo Atendimento por IA para Terapeutas. Como posso te chamar?\"\n      },\n      {\n        \"step\": \"Confirmar se √© terapeuta\",\n        \"instructions\": \"Ap√≥s receber o nome, confirmar se a pessoa √© terapeuta\",\n        \"example_message\": \"Prazer, Voc√™ √© terapeuta ou atua em outra √°rea da sa√∫de?\"\n      },\n      {\n        \"step\": \"Explica√ß√£o breve da solu√ß√£o\",\n        \"instructions\": \"Se confirmar que √© terapeuta, explicar brevemente o benef√≠cio da solu√ß√£o\",\n        \"example_message\": \"N√≥s ajudamos terapeutas a terem um atendimento inteligente no WhatsApp, como uma secret√°ria virtual que acolhe seus pacientes e organiza a comunica√ß√£o, poupando seu tempo.\"\n      },\n      {\n        \"step\": \"Identificar o maior desafio\",\n        \"instructions\": \"Antes de oferecer reuni√£o, perguntar qual √© o maior desafio atual no atendimento\",\n        \"example_message\": \"Hoje, qual √© o maior desafio que voc√™ enfrenta no seu atendimento? Seria dificuldade para contratar pessoas, agilidade nas respostas, atendimento fora do hor√°rio comercial, ou outra situa√ß√£o?\"\n      },\n      {\n        \"step\": \"Conectar solu√ß√£o √† dor\",\n        \"instructions\": \"Ap√≥s identificar a dor, refor√ßar que a solu√ß√£o pode ajudar especificamente nesse ponto\",\n        \"example_message\": \"Entendo. Nossa solu√ß√£o foi criada exatamente para ajudar terapeutas com essa dificuldade!\"\n      },\n      {\n        \"step\": \"Explica√ß√£o adicional da solu√ß√£o\",\n        \"instructions\": \"Antes de oferecer a reuni√£o, explicar detalhes extras da solu√ß√£o\",\n        \"example_message\": \"Nossa IA entende √°udios enviados pelos seus clientes, interpreta m√∫ltiplas mensagens de texto e, ap√≥s coletar informa√ß√µes sobre o motivo da busca por terapia, ela tamb√©m te notifica em um grupo exclusivo com o nome do potencial cliente e um resumo do seu caso.\"\n      },\n      {\n        \"step\": \"Oferecer agendamento de reuni√£o\",\n        \"instructions\": \"Depois de explicar a funcionalidade, convidar para agendar uma reuni√£o\",\n        \"example_message\": \"Gostaria que eu te mostrasse tudo isso em detalhes numa reuni√£o r√°pida de 30 minutos?\"\n      },\n      {\n        \"step\": \"Agendar reuni√£o\",\n        \"instructions\": \"Se a pessoa demonstrar interesse, pedir para sugerir um dia e um per√≠odo (manh√£ ou tarde)\",\n        \"example_message\": \"Que dia e per√≠odo (manh√£ ou tarde) seria melhor para voc√™? Assim organizamos tudo certinho.\"\n      },\n      {\n        \"step\": \"Confirma√ß√£o de agendamento\",\n        \"instructions\": \"Ap√≥s receber a sugest√£o, informar que um especialista entrar√° em contato para confirmar o hor√°rio certinho e enviar o n√∫mero de protocolo\",\n        \"example_message\": \"Perfeito! Vou pedir para um dos nossos especialistas entrar em contato para confirmar direitinho o hor√°rio com voc√™. Seu n√∫mero de protocolo √© 338201. At√© breve!\"\n      }\n    ]\n  }\n}\n"}},"id":"d99f5491-cd92-46fa-9643-388c6e3aaa47","name":"Atendente","type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.6,"position":[3600,1760]},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Dados').item.json.Telefone }}","contextWindowLength":20},"type":"@n8n/n8n-nodes-langchain.memoryPostgresChat","typeVersion":1.3,"position":[3660,1940],"id":"37e32edb-358e-4055-8519-98cdf6017449","name":"Postgres Chat Memory"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.output }}","rightValue":"338201","operator":{"type":"string","operation":"notContains"},"id":"2aa763f7-cf04-44e7-9bbb-8f8de823aef8"}],"combinator":"and"},"renameOutput":true,"outputKey":"Continuar na IA"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"820760d6-3546-4007-8917-55d366a74261","leftValue":"={{ $json.output }}","rightValue":"338201","operator":{"type":"string","operation":"contains"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Avisar Lead grupo"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[4040,1840],"id":"7416efdd-af43-4ef5-ac9d-e21d06dd4c48","name":"Switch2"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[5120,2520],"id":"7005181e-f436-45e1-99de-c3e5bcbce870","name":"OpenAI Chat Model2"},{"parameters":{"content":"","height":400,"width":1620,"color":4},"type":"n8n-nodes-base.stickyNote","position":[4320,2240],"typeVersion":1,"id":"af14795f-cf63-4e65-a311-d6f4d4e9b5ad","name":"Sticky Note44"},{"parameters":{"content":"# AVISAR NOVO LEAD NO GRUPO","height":80,"width":656,"color":5},"id":"5e8e7e6f-54a4-4bf6-9dae-a4915b979056","name":"Sticky Note45","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[4340,2260]},{"parameters":{"resource":"messages-api","instanceName":"Breno2","remoteJid":"={{ $('Dados').item.json.Telefone }}","messageText":"={{ $json.output }}","options_message":{"delay":4200,"linkPreview":false}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[5320,1900],"id":"0608241f-dc72-450c-9821-c5bfc1258941","name":"Evolution API"},{"parameters":{"resource":"messages-api","instanceName":"Breno2","remoteJid":"={{ $('Dados').item.json.Telefone }}","messageText":"={{ $json.output }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[4360,2360],"id":"cd889697-9bca-4d14-8774-6975990c7316","name":"Evolution API1"},{"parameters":{"resource":"messages-api","instanceName":"Breno2","remoteJid":"120363418914433116@g.us","messageText":"={{ (() => { \n  const telefone = $('Dados').item.json.Telefone;\n  return 'üö® Novo Lead: wa.me/' + telefone.split('@')[0] + ' üö®';\n})() }}\n\n*Cliente:* {{ $('Dados').item.json.NomeWpp }}\n\n*CASO:*\n{{ $json.text }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[5480,2360],"id":"876c7294-2b43-4ff0-a2e0-912ec3917856","name":"Evolution API2"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3,"position":[5040,1320],"id":"7bb3b8e2-ae9d-4a9d-9d4d-2bea6239a4a8","name":"Merge1"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"defac08a-6745-422b-bb05-90da9f47d91b","leftValue":"={{ $('Busca Telefone').last().json.values() }}","rightValue":"","operator":{"type":"array","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[4540,1320],"id":"2098c70a-717f-4592-bffc-8a79ff92bf58","name":"If4"},{"parameters":{"content":"","height":380,"width":1380,"color":4},"type":"n8n-nodes-base.stickyNote","position":[4320,1180],"typeVersion":1,"id":"8821159d-b31b-4c29-a5b3-b17d7839dd83","name":"Sticky Note54"},{"parameters":{"content":"# Cadastra Chat Supabase","height":80,"width":450,"color":5},"id":"586dd1a1-ecfe-4188-a38e-43e40b4ece22","name":"Sticky Note55","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[4340,1200]},{"parameters":{"operation":"get","tableId":"chats","filters":{"conditions":[{"keyName":"phone","keyValue":"={{ $('Webhook EVO').item.json.body.data.key.remoteJid }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[4380,1320],"id":"4e012693-4923-403d-8d31-dc9cd85b31f2","name":"Busca Telefone","alwaysOutputData":true,"onError":"continueRegularOutput"},{"parameters":{"tableId":"chats","fieldsUi":{"fieldValues":[{"fieldId":"phone","fieldValue":"={{ $('Dados').item.json.Telefone }}"},{"fieldId":"updated_at","fieldValue":"={{ $now}}"},{"fieldId":"created_at","fieldValue":"={{ $now}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[4820,1220],"id":"fb386a8b-6168-4958-b6ee-28e09e9c404c","name":"Adiciona CHAT supabase"},{"parameters":{"operation":"update","tableId":"chats","filters":{"conditions":[{"keyName":"phone","condition":"eq","keyValue":"={{ $('Dados').item.json.Telefone }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"updated_at","fieldValue":"={{ $now }}"},{"fieldId":"created_at","fieldValue":"={{ $now }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[4840,1400],"id":"aa0d4916-1281-4979-aec4-8b843f262594","name":"Atualiza CHAT Supabase","alwaysOutputData":true},{"parameters":{"tableId":"chat_messages","fieldsUi":{"fieldValues":[{"fieldId":"phone","fieldValue":"={{ $('Dados').item.json.Telefone }}"},{"fieldId":"bot_message","fieldValue":"={{ $('Atendente').item.json.output }}"},{"fieldId":"user_message","fieldValue":"={{ $('Dados').item.json.message.content }}"},{"fieldId":"message_type","fieldValue":"={{ $('Dados').item.json.body.event }}"},{"fieldId":"created_at","fieldValue":"={{ $now }}"},{"fieldId":"nomewpp","fieldValue":"={{ $('Dados').item.json.NomeWpp }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5240,1320],"id":"fd9a4a4f-a7b7-4fb5-bdb9-4add592343ad","name":"Cria Hist√≥rico Supabase"},{"parameters":{"fieldToSplitOut":"output.messages","options":{"destinationFieldName":"output"}},"id":"1bb04cec-8ff8-468a-b8d0-1e6a60c5c1c8","name":"Split de Mensagem","type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[4820,1880]},{"parameters":{"amount":1},"id":"7ea97dad-e835-4d39-8058-15e4fa4b9357","name":"1 segundo","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[5540,1900],"webhookId":"a2c69e1c-13fe-44a2-962c-1249288537eb"},{"parameters":{"operation":"delete","key":"={{ $('Dados').item.json.Telefone }}"},"id":"a3988c8a-d09c-4dc8-99ff-853b2972543d","name":"Delete Memory","type":"n8n-nodes-base.redis","typeVersion":1,"position":[5440,1320]},{"parameters":{"name":"buscar_documentos","description":"Analise o documento se encontrar uma informa√ß√£o que seja relevante traga o texto dele como resposta sem altera√ß√µes, caso n√£o encontre devolva o resultado em branco sem nem um texto","topK":2},"id":"3eb83bc5-d2ea-4b4f-90e7-cb42a4a12417","name":"buscar_documentos","type":"@n8n/n8n-nodes-langchain.toolVectorStore","typeVersion":1,"position":[2960,1840]},{"parameters":{"operation":"getAll","tableId":"chat_messages","matchType":"allFilters","filters":{"conditions":[{"keyName":"phone","condition":"eq","keyValue":"={{ $('Dados').item.json.Telefone }}"},{"keyName":"active","condition":"eq","keyValue":"true"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[4560,2360],"id":"4441040b-bcff-40d3-9c52-0226bb58e97e","name":"ListMessages-Supabase2","alwaysOutputData":true},{"parameters":{"aggregate":"aggregateAllItemData","destinationFieldName":"conversas","include":"specifiedFields","fieldsToInclude":"id,message_type,created_at,user_message, bot_message,phone","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[4760,2360],"id":"84523844-8699-4cb8-9233-6c8fb447a942","name":"Aggregate2"},{"parameters":{"jsCode":"return $('Aggregate2').all().map(item => {\n  // Tenta acessar a propriedade 'conversas' e verifica se ela √© um array\n  const conversas = item.json.conversas || []; // Garante que √© pelo menos um array vazio\n\n  if (!Array.isArray(conversas)) {\n    throw new Error(\"A propriedade 'conversas' n√£o √© um array.\");\n  }\n\n  // Processa cada conversa e verifica as mensagens\n  const textoUnico = conversas.map(conversa => {\n    const cliente = conversa.user_message || \"sem mensagem do chatbot\";\n    const agente = conversa.bot_message || \"sem resposta\";\n    \n    // Verifica se a data existe e formata\n    const dataOriginal = conversa.created_at || \"Data da Mensagem indispon√≠vel\";\n    const dataFormatada = dataOriginal !== \"Data da Mensagem indispon√≠vel\"\n      ? formatarData(dataOriginal)\n      : dataOriginal;\n\n    return `em: ${dataFormatada}\\n\\n - agente(chatbot): ${agente} \\n - cliente: ${cliente}\\n`;\n  }).join('\\n\\n');\n\n  // Retorna o texto final como resultado\n  return {\n    json: {\n      texto: textoUnico\n    }\n  };\n});\n\n// Fun√ß√£o para formatar a data\nfunction formatarData(dataString) {\n  const data = new Date(dataString); // Converte a string em objeto Date\n  if (isNaN(data)) {\n    return \"Data inv√°lida\"; // Retorna se a data n√£o for v√°lida\n  }\n  \n  // Formata no padr√£o DD/MM/YYYY HH:mm\n  const dia = String(data.getDate()).padStart(2, '0');\n  const mes = String(data.getMonth() + 1).padStart(2, '0'); // M√™s come√ßa em 0\n  const ano = data.getFullYear();\n  const horas = String(data.getHours()).padStart(2, '0');\n  const minutos = String(data.getMinutes()).padStart(2, '0');\n  \n  return `${dia}/${mes}/${ano} ${horas}:${minutos}`;\n}\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[4940,2360],"id":"22ce1120-5b55-4436-badc-3bd1c33a40e0","name":"Code6"},{"parameters":{"promptType":"define","text":"={\n  \"role\": \"Agente Resumidor de atendimento\",\n  \"proposito\": \"Analisar conversas cliente-agente e criar resumos detalhados do atendimento\",\n  \"instrucoes\": {\n    \"tarefa_principal\": \"Extrair e resumir apenas sobre o atendimento do cliente a partir das conversas\",\n    \"formato\": \"Incluir data da sess√£o quando dispon√≠vel\",\n    \"foco\": \"demandas do cliente, excluir respostas do agente\",\n    \"estilo\": \"Resumos detalhados mas concisos\",\n    \"evitar\": \"Dicas de uso, informa√ß√µes extras ou explica√ß√µes\",\n    \"Me de o resultado somente com o resumo sem caracteres especiais\"\n  },\n  \"formato_entrada\": {\n    \"conversa\": \"{{ $json.texto }}\"\n  },\n  \"formato_saida\": {\n    \"resumo\": \"Descri√ß√£o concisa do caso do cliente e data que ele gostaria de agendar uma reruni√£o\"\n  }\n}"},"type":"@n8n/n8n-nodes-langchain.chainLlm","typeVersion":1.5,"position":[5140,2360],"id":"91c7dd6d-7602-447e-8faf-31b3ca60eae5","name":"Basic LLM Chain1"},{"parameters":{"operation":"get","tableId":"dados_cliente","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Dados').item.json.Telefone }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-1340,1940],"id":"2a83e180-1594-4801-bbc3-74c32cc41aae","name":"Supabase","alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"4a6d9aac-8565-4c58-abe3-8741393a5535","leftValue":"={{ $json.telefone }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1140,1880],"id":"fd811ecf-c2fc-4f67-b0bf-afb4b268c0dd","name":"If1"},{"parameters":{"tableId":"dados_cliente","fieldsUi":{"fieldValues":[{"fieldId":"nomewpp","fieldValue":"={{ $('Dados').item.json.NomeWpp }}"},{"fieldId":"telefone","fieldValue":"={{ $('Webhook EVO').item.json.body.data.key.remoteJid }}"},{"fieldId":"created_at","fieldValue":"={{ $now}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-960,2020],"id":"2062f7e0-4b53-4091-a6f7-9672766d2ab7","name":"Supabase1"},{"parameters":{"content":"","height":620,"width":980,"color":4},"type":"n8n-nodes-base.stickyNote","position":[1600,1580],"typeVersion":1,"id":"135e9b65-c9d5-4a63-8314-0c5b33eac6bc","name":"Sticky Note17"},{"parameters":{"content":"","height":940,"width":960,"color":4},"type":"n8n-nodes-base.stickyNote","position":[580,1540],"typeVersion":1,"id":"c5172028-9492-4f78-b499-aad2dba480da","name":"Sticky Note20"},{"parameters":{"content":"","height":440,"width":740,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-1380,1760],"typeVersion":1,"id":"d0869d01-bce6-4a90-a032-d701651e58a7","name":"Sticky Note22"},{"parameters":{"content":"# Cadastrar Lead Supa Base","height":80,"width":596,"color":4},"id":"c2d9086d-5554-45d3-999e-dae2b84d7c96","name":"Sticky Note23","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1380,1780]},{"parameters":{"content":"","height":500,"width":1120,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-620,1700],"typeVersion":1,"id":"6796e702-bb4b-43a3-a756-890391d32473","name":"Sticky Note26"},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-1580,1380],"typeVersion":1,"id":"c0e3d44f-d564-4221-b1df-8e259a21a0f9","name":"Sticky Note31"},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-780,980],"typeVersion":1,"id":"1279da95-bbd5-45ad-ade4-f40184d7239f","name":"Sticky Note33"},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-540,1380],"typeVersion":1,"id":"992b1d27-6c94-457e-89bf-d03abd8f2374","name":"Sticky Note37"},{"parameters":{"httpMethod":"POST","path":"aula","options":{}},"id":"cab5dda8-4019-464e-aecc-fd85c709c2de","name":"Webhook EVO","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1980,1960],"webhookId":"7ecd43ed-123c-4fef-b86d-f9ce39e55d64"},{"parameters":{"content":"# Pausar IA","height":80,"width":216,"color":4},"id":"e2f65f02-b433-499c-9667-4e1c34874886","name":"Sticky Note41","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-620,1700]},{"parameters":{"operation":"executeQuery","query":"create table dados_cliente (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  telefone text, \n  nomewpp text,\n  atendimento_ia text\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-1240,1000],"id":"ee4d9fc1-83da-4528-90da-2e21597c097e","name":"Cria Tabela Dados Cliente","credentials":{"postgres":{"id":"ir88UPOZhSv8ZCbU","name":"Postgres Allan.souto@outlook"}}},{"parameters":{"operation":"executeQuery","query":"-- Create a table to store your documents\ncreate table documents (\n  id bigserial primary key,\n  content text, -- corresponds to Document.pageContent\n  metadata jsonb, -- corresponds to Document.metadata\n  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-180,1020],"id":"1dc134ee-c745-414a-b306-413964cad558","name":"Cria Tabela Documentos","credentials":{"postgres":{"id":"ir88UPOZhSv8ZCbU","name":"Postgres Allan.souto@outlook"}}},{"parameters":{"operation":"executeQuery","query":"delete from documents","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-480,1400],"id":"a794227f-fe47-4a34-a77f-30b6ba686f8a","name":"Deleta Conte√∫do Documentos"},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-520,980],"typeVersion":1,"id":"a37d0082-ed27-40bf-a2ff-85177953d8cc","name":"Sticky Note40"},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-240,980],"typeVersion":1,"id":"890f18eb-c41b-400a-bdff-67635815c27a","name":"Sticky Note48"},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-1560,980],"typeVersion":1,"id":"569d625a-4015-44ea-ac9c-37caf2df7af6","name":"Sticky Note49"},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-1040,980],"typeVersion":1,"id":"42fc5b30-5e78-44ee-9dd0-8996ba8bb642","name":"Sticky Note50"},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-1060,1380],"typeVersion":1,"id":"e8b91f1f-1cf9-43bd-8aab-827be4e668f6","name":"Sticky Note56"},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-1300,980],"typeVersion":1,"id":"069205ad-bccd-42e1-b0d3-c379a2dd92ab","name":"Sticky Note57"},{"parameters":{"operation":"executeQuery","query":"delete from n8n_chat_histories","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-1520,1420],"id":"c768e122-4f69-41f8-a615-405cc32f007b","name":"Deleta Hist√≥rico"},{"parameters":{"operation":"executeQuery","query":"create function match_documents (\n  query_embedding vector(1536),\n  match_count int default null,\n  filter jsonb DEFAULT '{}'\n) returns table (\n  id bigint,\n  content text,\n  metadata jsonb,\n  similarity float\n)\nlanguage plpgsql\nas $$\n#variable_conflict use_column\nbegin\n  return query\n  select\n    id,\n    content,\n    metadata,\n    1 - (documents.embedding <=> query_embedding) as similarity\n  from documents\n  where metadata @> filter\n  order by documents.embedding <=> query_embedding\n  limit match_count;\nend;\n$$;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-460,1000],"id":"49671554-10a7-4fc9-a289-8f8a07090e2a","name":"Cria fun√ß√£o Busca em Vetor","credentials":{"postgres":{"id":"ir88UPOZhSv8ZCbU","name":"Postgres Allan.souto@outlook"}}},{"parameters":{"operation":"executeQuery","query":"create extension vector;","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-720,1000],"id":"822935ef-ee4f-49ff-b032-6dc7fb3b2299","name":"Cria Extens√£o Vetor","credentials":{"postgres":{"id":"ir88UPOZhSv8ZCbU","name":"Postgres Allan.souto@outlook"}}},{"parameters":{"operation":"executeQuery","query":"create table chats (\n  id bigserial primary key,\n  created_at TIMESTAMPTZ, \n  phone text,\n  updated_at text\n);","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-980,1000],"id":"ff7af819-e7e2-4c6b-93cf-571ab2be339c","name":"Cria Tabela Chats","credentials":{"postgres":{"id":"ir88UPOZhSv8ZCbU","name":"Postgres Allan.souto@outlook"}}},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-800,1380],"typeVersion":1,"id":"2dec12ad-412c-4a27-9420-e928daa9e200","name":"Sticky Note65"},{"parameters":{"operation":"executeQuery","query":"delete from chats","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-740,1400],"id":"f6d55da5-dd66-474e-a717-f3ea93723866","name":"Deleta Conte√∫do Chats"},{"parameters":{"operation":"executeQuery","query":"delete from dados_cliente","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-1000,1400],"id":"3cede82b-48ad-4b4d-87f9-b04792885473","name":"Deleta Conte√∫do Dados Cliente"},{"parameters":{"content":"","height":200},"type":"n8n-nodes-base.stickyNote","position":[-1320,1380],"typeVersion":1,"id":"b2078e11-92e0-4ca4-aca0-d27d60eb5057","name":"Sticky Note66"},{"parameters":{"operation":"executeQuery","query":"delete from chat_messages","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-1260,1400],"id":"42f805c5-d9f7-4110-8835-f03639f5dee9","name":"Deleta Conte√∫do Chat_Messages"},{"parameters":{"operation":"executeQuery","query":"CREATE TABLE chat_messages (\n  id BIGSERIAL PRIMARY KEY,\n  created_at TIMESTAMPTZ, \n  phone TEXT,\n  nomewpp TEXT, \n  bot_message TEXT,\n  user_message TEXT, \n  message_type TEXT,\n  active BOOLEAN DEFAULT TRUE\n);\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-1500,1000],"id":"a9b9a6de-f2e1-4a45-a3c1-bd017110c6d3","name":"Cria Tabela Chat_Messages","credentials":{"postgres":{"id":"ir88UPOZhSv8ZCbU","name":"Postgres Allan.souto@outlook"}}},{"parameters":{"content":"","height":440,"width":600,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-2020,1760],"typeVersion":1,"id":"ca3ea549-0c34-45d2-83a6-ead1ecf41f60","name":"Sticky Note32"},{"parameters":{"content":"## WEBHOOK & ROTAS","height":80,"width":276,"color":4},"id":"ad4c1624-23be-4dec-a9a2-d01493ee92bb","name":"Sticky Note67","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-2000,1780]},{"parameters":{"operation":"toBinary","sourceProperty":"data","options":{"fileName":"file.png","mimeType":"image/png"}},"id":"b1ecfae5-d0b3-4a25-8f2d-5fea784d0bee","name":"Convert to File1","type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[840,2040]},{"parameters":{"assignments":{"assignments":[{"id":"3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655","name":"data","value":"={{ $('Webhook EVO').item.json.body.data.message.base64 }}","type":"string"}]},"options":{}},"id":"b899be7e-b739-4f61-a853-c2c182cac0c4","name":"Edit Fields3","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[700,2040]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"ade56c50-1520-4760-8df5-e99617d6d3ad","leftValue":"={{ $('Webhook EVO').item.json.body.data.message.imageMessage.caption }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"id":"9d5a0321-b7ee-4a14-a7f6-39f3b463b6be","name":"If3","type":"n8n-nodes-base.if","typeVersion":2,"position":[1180,2040]},{"parameters":{"operation":"push","list":"={{ $('Dados').item.json.Telefone }}","messageData":"={{ $('Dados').item.json.message.content }}, {{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}","tail":true},"id":"b7e31b09-7290-4e08-95cf-ee3a6ccc0deb","name":"Redis4","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1340,2060],"credentials":{"redis":{"id":"kixoLDLu9Z8RemZk","name":"Redis Mytia - 04"}}},{"parameters":{"operation":"push","list":"={{ $('Dados').item.json.Telefone }}","messageData":"={{ $json.content.replace(/\\n/g, \"\\\\n\").replace(/['\"]/g, '').trim()  }}","tail":true},"id":"d9f68580-a97f-4732-bb86-0958dcf7b542","name":"Redis5","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1340,1880],"credentials":{"redis":{"id":"kixoLDLu9Z8RemZk","name":"Redis Mytia - 04"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"52aaf749-fe4f-44e4-880e-15b2bfc027f1","leftValue":"={{ $('Webhook EVO').item.json.body.data.messageType }}","rightValue":"extendedTextMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"e514e613-fd6a-48bd-b0ae-bae2448c810e","leftValue":"={{ $('Webhook EVO').item.json.body.data.messageType }}","rightValue":"conversation","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"text"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $('Webhook EVO').item.json.body.data.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"c0e434dd-1268-421d-b81b-3a5e90ed9550","leftValue":"={{ $('Webhook EVO').item.json.body.data.messageType }}","rightValue":"imageMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"image"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"2e7c9e37-3884-450a-a700-3971defadce6","leftValue":"{{ $('Webhook EVO').item.json.body.data.messageType }}","rightValue":"documento","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"documento"}]},"options":{}},"id":"f5ae15b7-749a-4b29-a90b-7c6089861c13","name":"Switch1","type":"n8n-nodes-base.switch","typeVersion":3,"position":[600,1800]},{"parameters":{"content":"# Mensagem Picotada","height":80,"width":396,"color":4},"id":"0d3d78a0-9f55-438e-94fc-d4e4738b6c8b","name":"Sticky Note3","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[1600,1580]},{"parameters":{"resource":"image","operation":"analyze","modelId":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"GPT-4O-MINI"},"text":"Analise a imagem e me traga um resumo simples e o mais curto poss√≠vel do que ela √©","inputType":"base64","options":{}},"id":"1fdc0729-42d8-45b2-b66a-2da132818ed4","name":"OpenAI1","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.6,"position":[1000,2040]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d5a342e9-585b-42ea-be44-644adae10199","leftValue":"={{ $json.Redis2 }}","rightValue":"={{ $json.Redis1 }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"id":"3f3894a8-469b-412b-8043-ce7964d13545","name":"Compara Get Memory1","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2240,1840]},{"parameters":{"operation":"push","list":"={{ $('Dados').item.json.Telefone }}","messageData":"={{ $('Dados').item.json.message.content }}","tail":true},"id":"84f1ffa6-8982-4ba9-a1f4-623b0edb0718","name":"Text Memory1","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1340,1560],"credentials":{"redis":{"id":"kixoLDLu9Z8RemZk","name":"Redis Mytia - 04"}}},{"parameters":{"operation":"push","list":"={{ $('Dados').item.json.Telefone }}","messageData":"={{ $json.text }}","tail":true},"id":"303c3dc6-0e6b-4f28-8d7a-1b6cc82bf8ee","name":"Audio Memory1","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1340,1720],"credentials":{"redis":{"id":"kixoLDLu9Z8RemZk","name":"Redis Mytia - 04"}}},{"parameters":{"assignments":{"assignments":[{"id":"f336a1ff-e577-489d-a739-1eb8bd509245","name":"Redis2","value":"={{ $json.propertyName }}","type":"string"},{"id":"946d1420-e379-46e3-8fcd-3816340fbabb","name":"Redis1","value":"={{ $('Get Memory 1').item.json.propertyName }}","type":"string"}]},"options":{}},"id":"8d2d76a1-37d7-4810-b019-f9ff5bac0685","name":"Edit Fields8","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2080,1840]},{"parameters":{"amount":40},"id":"464c63d5-121a-4272-ad4b-ba6a0c0e145f","name":"Wait3","type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[1780,1840],"webhookId":"9f0edf0b-ca36-42a6-bab6-bf62ca08ac51"},{"parameters":{"operation":"get","key":"={{ $('Dados').item.json.Telefone }}","options":{}},"id":"729ea7f3-0ed2-4f95-a8e8-080deaa9f8d5","name":"Get Memory 1","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1640,1840]},{"parameters":{"operation":"get","key":"={{ $('Dados').item.json.Telefone }}","options":{}},"id":"88637ec7-54ce-4a10-b952-3ab6a8321530","name":"Get Memory 2","type":"n8n-nodes-base.redis","typeVersion":1,"position":[1940,1840]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $('Dados').item.json.message.event }}","rightValue":"outcoming","operator":{"type":"string","operation":"equals"},"id":"7c878f9b-2c93-4061-954a-a832153e7647"}],"combinator":"and"},"renameOutput":true,"outputKey":"outcoming"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"d7b42536-638f-4128-b51b-6aa913e9d9bc","leftValue":"={{ $('Dados').item.json.message.event }}","rightValue":"incoming","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"incoming"}]},"options":{}},"id":"f9932820-ea83-4074-93cf-0268024b0468","name":"Switch6","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-600,1980]},{"parameters":{"content":"# Filtro de mensagem","height":80,"width":356,"color":4},"id":"426ae8ef-37a1-41eb-b891-8a55a9d8d77d","name":"Sticky Note7","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[580,1540]},{"parameters":{"jsCode":"const redis1 = JSON.parse($json.Redis1);\nconst redis2 = JSON.parse($json.Redis2);\n\nconst combinadoSemDuplicatas = Array.from(new Set([...redis1, ...redis2]));\n\nconst mensagem = combinadoSemDuplicatas.join(\" \");\n\nreturn [{ json: { mensagem_completa: mensagem } }];"},"id":"faf19920-5e57-4e6d-942c-5a88a5981e35","name":"Mensagem Completa","type":"n8n-nodes-base.code","typeVersion":2,"position":[2460,1820]},{"parameters":{"operation":"toBinary","sourceProperty":"data","options":{"fileName":"file.ogg","mimeType":"application/ogg"}},"id":"92b924b4-a32f-47bd-a0fe-076d8e5bdf5d","name":"Convert to File","type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[980,1840]},{"parameters":{"assignments":{"assignments":[{"id":"3c5ccbc9-69d1-4b13-a7c3-e6945bc8c655","name":"data","value":"={{ $('Webhook EVO').item.json.body.data.message.base64 }}","type":"string"}]},"options":{}},"id":"3e0bd226-3b68-4964-ae90-467e633c3ff0","name":"Edit Fields","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[820,1840]},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"id":"bab54098-2174-43cf-bb45-528ab8c43035","name":"OpenAI","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.6,"position":[1160,1840]},{"parameters":{"model":{"__rl":true,"value":"gpt-4o-mini","mode":"list","cachedResultName":"gpt-4o-mini"},"options":{}},"id":"36be9db8-f56f-4dcb-a3dc-8ebcbd797fbd","name":"OpenAI Model","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","position":[-1300,3160],"typeVersion":1.2},{"parameters":{"content":"## Agente treinamento RAG, ativa√ß√£o autom√°tica como o texto: TreinoIA1212:","height":840,"width":2220,"color":4},"id":"b94b28e6-4084-4e88-ab57-f53c844c9cad","name":"Sticky Note11","type":"n8n-nodes-base.stickyNote","position":[-1340,2680],"typeVersion":1},{"parameters":{"descriptionType":"manual","toolDescription":"Use para buscar informa√ß√µes na planilha caso tenha um treinamento paricido devovlea o numeroo da rtoow para ela ser atualziada","documentId":{"__rl":true,"value":"1Q-s8_cB8PO-ZZ8ZZCzzaTezL-3VHXW4_vVu0iRNxWfI","mode":"list","cachedResultName":"Aula nova","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Q-s8_cB8PO-ZZ8ZZCzzaTezL-3VHXW4_vVu0iRNxWfI/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"P√°gina1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Q-s8_cB8PO-ZZ8ZZCzzaTezL-3VHXW4_vVu0iRNxWfI/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheetsTool","typeVersion":4.5,"position":[-1160,3200],"id":"568e9e00-38a3-4676-bd98-ab9cd1ffdeea","name":"Treinamento_feito"},{"parameters":{"mode":"insert","tableName":{"__rl":true,"value":"documents","mode":"list","cachedResultName":"documents"},"options":{"queryName":"match_documents"}},"id":"11547b4b-be41-48f7-9e2a-c7011c88cb77","name":"Insert into Supabase Vectorstore1","type":"@n8n/n8n-nodes-langchain.vectorStoreSupabase","typeVersion":1,"position":[540,2980]},{"parameters":{"separator":"/n","chunkSize":1200,"chunkOverlap":200},"id":"e1b95e0b-aaa6-4121-886f-1b458da190d7","name":"Character Text Splitter1","type":"@n8n/n8n-nodes-langchain.textSplitterCharacterTextSplitter","typeVersion":1,"position":[680,3380]},{"parameters":{"aggregate":"aggregateAllItemData","include":"allFieldsExcept","fieldsToExclude":"rew_number","options":{}},"id":"c8203da0-ed97-461c-be85-75ed83e111ac","name":"Aggregate1","type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[140,2980]},{"parameters":{"model":"text-embedding-3-small","options":{}},"id":"40edfed4-e0c0-44ed-ad92-32b0641c92c5","name":"Embeddings OpenAI2","type":"@n8n/n8n-nodes-langchain.embeddingsOpenAi","typeVersion":1,"position":[400,3220]},{"parameters":{"jsonMode":"expressionData","jsonData":"={{ $json.data || $json.text || $json.concatenated_data }}","options":{"metadata":{"metadataValues":[{"name":"Arquivo","value":"={{ $('Download File1').item.json.name }}"}]}}},"id":"b1ec6d49-15c5-4498-a8a6-ac137d6b66e1","name":"Default Data Loader1","type":"@n8n/n8n-nodes-langchain.documentDefaultDataLoader","typeVersion":1,"position":[560,3220]},{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"options":{"googleFileConversion":{"conversion":{"docsToFormat":"text/plain"}}}},"id":"c03554fd-9019-4142-8d33-e82383112f66","name":"Download File1","type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[-520,2940],"executeOnce":false},{"parameters":{"operation":"xlsx","options":{}},"id":"e12ca103-c215-4b43-8778-e1c7da2aee87","name":"Extract from Excel2","type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[-20,2880]},{"parameters":{"promptType":"define","text":"={{ $('Webhook EVO').item.json.body.data.message.conversation || '' }}","options":{"systemMessage":"={\n  \"name\": \"AgenteTreinamentoPlanilha\",\n  \"objectives\": [\n    \"Receber um texto e corrigi-lo\",\n    \"Verificar se j√° existe pergunta similar na planilha\",\n    \"Atualizar a planilha com a pergunta e a resposta corrigida\",\n    \"Caso pe√ßa para atualizar, n√£o execute nem uma tool\"\n  ],\n  \"tools\": [\n    {\n      \"name\": \"Treinamento_feito\",\n      \"description\": \"Verifica se existe conte√∫do similar antes de atualizar, caso exista deve ser removido ou substitu√≠do\"\n    },\n    {\n      \"name\": \"Atualizar_treinamento\",\n      \"description\": \"Cria ou atualiza linha na planilha com as colunas: Pergunta e Resposta\"\n    }\n  ],\n  \"general_rules\": [\n    \"N√£o mencionar a planilha ou as ferramentas na resposta ao usu√°rio\",\n    \"Corrigir sempre o texto recebido antes de registrar no sistema\",\n    \"Seja preciso e consistente ao preencher as colunas pergunta e resposta\",\n    \"Gere sua resposta sem acentos nas palavras ou caracteres especiais\"\n  ]\n}\n"}},"id":"38d46b94-4cc8-406f-bf15-01564a50f7dc","name":"Agente Treinamento RAG","type":"@n8n/n8n-nodes-langchain.agent","position":[-1300,2920],"typeVersion":1.8},{"parameters":{"content":"# Ferramentas para criar\n\n","height":80,"width":456,"color":4},"id":"aedc5592-2acd-47f4-86e2-900122f999b0","name":"Sticky Note8","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1560,880]},{"parameters":{"content":"# Ferramentaspara apagar\n\n","height":80,"width":496,"color":3},"id":"3182eb46-1d6f-43ea-b396-f73301dba452","name":"Sticky Note9","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1600,1280]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5922557b-71e7-4390-af21-10b683e7a875","leftValue":"={{ $json.Telefone }}","rightValue":"553173374875@s.whatsapp.net","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Numero pessoal"},{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"conditions":[{"id":"9865cb5b-33da-490c-afc3-186457d5b564","operator":{"type":"string","operation":"notStartsWith"},"leftValue":"={{ $json.message.content }}","rightValue":"TreinoIA1212:"}],"combinator":"and"},"renameOutput":true,"outputKey":"Rota normal"},{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"conditions":[{"id":"5a9a1fee-b408-469f-a08c-e8d690fc9792","operator":{"type":"string","operation":"startsWith"},"leftValue":"={{ $json.message.content }}","rightValue":"TreinoIA1212:"}],"combinator":"and"},"renameOutput":true,"outputKey":"Treinamento IA"}]},"options":{}},"id":"8f8db7c8-4d16-4ad9-816e-e70e28ce7fc0","name":"Rotas","type":"n8n-nodes-base.switch","position":[-1600,1960],"typeVersion":3.2},{"parameters":{"operation":"update","tableId":"dados_cliente","filters":{"conditions":[{"keyName":"telefone","condition":"eq","keyValue":"={{ $('Dados').item.json.Telefone }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"atendimento_ia","fieldValue":"pause"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-260,1740],"id":"cb8129f9-34e8-4e12-816b-a1253c8d1aa3","name":"Pausar IA","credentials":{"supabaseApi":{"id":"gRdkoznVdJcWZBEW","name":"Supabase Allan.souto@outlook"}}},{"parameters":{"operation":"get","tableId":"dados_cliente","filters":{"conditions":[{"keyName":"telefone","keyValue":"={{ $('Dados').item.json.Telefone }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-260,2060],"id":"a5d30e4b-0f1c-48e0-be96-828f0b682d4a","name":"Verificar Pause"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.atendimento_ia }}","rightValue":"pause","operator":{"type":"string","operation":"notStartsWith"},"id":"ff00573b-e517-43c6-8644-14a4fe8565d1"}],"combinator":"and"},"renameOutput":true,"outputKey":"Ia Ativa"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"3ef0e01c-cc14-4663-bb4d-2905b350c3ab","leftValue":"={{ $json.atendimento_ia }}","rightValue":"pause","operator":{"type":"string","operation":"startsWith"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Ia pausada"}]},"options":{}},"id":"8d217e1c-d305-4b58-8ba2-271b73d124ce","name":"Rota Atendimento","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-40,2060]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"conditions":[{"id":"9865cb5b-33da-490c-afc3-186457d5b564","operator":{"type":"string","operation":"notEquals"},"leftValue":"={{ $('Rotas').item.json.message.content }}","rightValue":"Atendimento finalizado"}],"combinator":"and"},"renameOutput":true,"outputKey":"IA Pausada"},{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"conditions":[{"id":"5a9a1fee-b408-469f-a08c-e8d690fc9792","operator":{"type":"string","operation":"equals"},"leftValue":"={{ $('Rotas').item.json.message.content }}","rightValue":"Atendimento finalizado"}],"combinator":"and"},"renameOutput":true,"outputKey":"Reativar IA"}]},"options":{}},"id":"d8dc036b-0ce9-4438-9d63-3e6c2962404f","name":"Rotas1","type":"n8n-nodes-base.switch","position":[-460,1880],"typeVersion":3.2},{"parameters":{"operation":"update","tableId":"dados_cliente","filters":{"conditions":[{"keyName":"telefone","condition":"eq","keyValue":"={{ $('Dados').item.json.Telefone }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"atendimento_ia","fieldValue":"reativada"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-80,1900],"id":"c4bd9fce-1928-4dd4-aaab-b4b8019b3225","name":"Reativar IA"},{"parameters":{"assignments":{"assignments":[{"id":"11800d83-ecca-4f9c-a878-a2419db0c8e9","name":"message.chat_id","value":"={{ $('Webhook EVO').item.json.body.data.key.remoteJid || '' }}","type":"string"},{"id":"c33f9527-e661-49e5-8e5e-64f3b430928a","name":"message.content_type","value":"={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation ? 'text' : '' }}{{ $('Webhook EVO').item.json.body.data.message.audioMessage ? 'audio' : '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage ? 'image' : '' }}","type":"string"},{"id":"06eba1c9-cff0-4f68-b6da-6bb0092466b7","name":"message.content","value":"={{ $('Webhook EVO').item.json.body.data.message.extendedTextMessage?.text || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.caption || '' }}{{ $('Webhook EVO').item.json.body.data.message.conversation || '' }}","type":"string"},{"id":"b97f1af3-5361-46fc-9303-d644921231d8","name":"message.timestamp","value":"={{ $('Webhook EVO').item.json.body.data.messageTimestamp.toDateTime('s').toISO() }}","type":"string"},{"id":"dc3dc59c-90a3-4a45-bea2-de092c91083b","name":"message.content_url","value":"={{ $('Webhook EVO').item.json.body.data.message.audioMessage?.url || '' }}{{ $('Webhook EVO').item.json.body.data.message.imageMessage?.url || '' }}","type":"string"},{"id":"8b01a818-a456-476e-bace-adefe2f04eb4","name":"message.event","value":"={{ $('Webhook EVO').item.json.body.data.key.fromMe ? 'outcoming' : 'incoming' }}","type":"string"},{"id":"886e3751-e39b-4fc6-98d1-3113eaeebbb4","name":"=body.event","value":"={{ $('Webhook EVO').item.json.body.event }}","type":"string"},{"id":"d04a0c6e-7842-41d2-bdb0-c0ce51d6dad7","name":"Telefone","value":"={{ $('Webhook EVO').item.json.body.data.key.remoteJid }}","type":"string"},{"id":"a57db642-3e13-452e-bb5b-19f7e9f3bd5d","name":"NomeWpp","value":"={{ $json.body.data.pushName }}","type":"string"}]},"options":{}},"id":"aff13ebd-4833-4964-befd-99f020c84135","name":"Dados","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1780,1960]},{"parameters":{"amount":1,"unit":"minutes"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-260,1900],"id":"f7b56824-646a-4703-b19d-d964a722288a","name":"Wait","webhookId":"b9c0dc3b-a05b-4e71-bcbe-fee8c71142a2"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Dados').item.json.Telefone }}","message":"={\"type\": \"ai\", \"content\": \"{{ $('Rotas').item.json.message.content.replace(/\\n/g, ' ') }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[300,2020],"id":"b3320bc1-5f6c-4003-9d9a-c6e5bb1281bb","name":"Salvar Historicoo Humano1"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1,"position":[2660,1860],"id":"74573143-7664-4564-9419-5c11e829f847","name":"OpenAI Chat Model4"},{"parameters":{"promptType":"define","text":"={{ $json.mensagem_completa }}","options":{"systemMessage":"={\n  \"name\": \"AgenteRag\",\n  \"objectives\": [\n    \"Responder somente com dados obtidos da ferramenta buscar_documentos, sem dicas extras\"\n  ],\n  \"tools\": [\n    {\n      \"name\": \"buscar_documentos\",\n      \"description\": \"Use esta ferramenta para obter a resposta. Se n√£o houver dados, retorne: n√£o invente resposta somente do que vier da tool buscar_documentos'.\",\n      \"required\": true\n    }\n  ],\n  \"general_rules\": [\n    \"N√£o inventar respostas\",\n    \"Sempre usar a ferramenta buscar_documentos\",\n    \"caso n√£o tenha uma resposta envie a resposta assim: sem dica de resposta\"\n  ]\n}\n"}},"id":"5e0a34de-db37-4a40-9ac0-cfadb06f49ac","name":"Agente Rag","type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.6,"position":[2660,1680]},{"parameters":{"content":"# Agente RAG","height":80,"width":336,"color":4},"id":"11f3a36a-5839-433c-a26e-f0a6f4cbf421","name":"Sticky Note10","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2620,1580]},{"parameters":{"content":"","height":380,"width":1680,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-1620,840],"typeVersion":1,"id":"2ca3a1c1-d76d-4919-ba88-11e96a0b7562","name":"Sticky Note12"},{"parameters":{"content":"","height":380,"width":1680,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-1620,1240],"typeVersion":1,"id":"aafef5ee-a6e6-4904-869a-5aae9fce7149","name":"Sticky Note13"},{"parameters":{"content":"","height":620,"width":820,"color":4},"type":"n8n-nodes-base.stickyNote","position":[2600,1580],"typeVersion":1,"id":"5b02f220-4025-497e-8d47-5651135c1b98","name":"Sticky Note6"},{"parameters":{"descriptionType":"manual","toolDescription":"Analise se j√° existeuma coluca pareceida se sim atualize ela se n√£o crie uma nova linha","operation":"appendOrUpdate","documentId":{"__rl":true,"value":"1Q-s8_cB8PO-ZZ8ZZCzzaTezL-3VHXW4_vVu0iRNxWfI","mode":"list","cachedResultName":"Aula nova","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Q-s8_cB8PO-ZZ8ZZCzzaTezL-3VHXW4_vVu0iRNxWfI/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"P√°gina1","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1Q-s8_cB8PO-ZZ8ZZCzzaTezL-3VHXW4_vVu0iRNxWfI/edit#gid=0"},"columns":{"mappingMode":"defineBelow","value":{"Pergunta":"={{ $fromAI(\"Pergunta\",\"isso √© a pergunta\") }}","Resposta":"={{ $fromAI(\"Resposta\",\"isso √© a resposta\") }}"},"matchingColumns":["Pergunta"],"schema":[{"id":"Pergunta","displayName":"Pergunta","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"Resposta","displayName":"Resposta","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"id":"c521846f-519c-4ad0-9bd1-47d2c9e2e6f5","name":"Atualizar_treinamento","type":"n8n-nodes-base.googleSheetsTool","position":[-960,3200],"typeVersion":4.5},{"parameters":{"operation":"text","options":{}},"id":"cb35a496-e90f-40fd-86bf-df392b71b51b","name":"Extract Document Text","type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[-20,3220],"alwaysOutputData":true},{"parameters":{"operation":"pdf","options":{}},"id":"fe0b90ca-b695-47c8-823a-f27daa77a5bd","name":"Extract PDF Text","type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[-20,2700]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"leftValue":"={{ $json.mimeType }}","rightValue":"application/pdf","operator":{"type":"string","operation":"equals"},"id":"d324b22b-cdf4-4216-a5ac-7db17ab11851"}],"combinator":"and"},"renameOutput":true,"outputKey":"PDF"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"2ae7faa7-a936-4621-a680-60c512163034","leftValue":"={{ $json.mimeType }}","rightValue":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"excel"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"8bd558b2-8c70-4edd-ab19-92540895ae46","leftValue":"={{ $json.mimeType }}","rightValue":"application/vnd.google-apps.spreadsheet","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"CVS"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":1},"conditions":[{"id":"fc193b06-363b-4699-a97d-e5a850138b0e","leftValue":"={{ $json.mimeType }}","rightValue":"application/vnd.google-apps.document","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Google Docs"}]},"options":{"fallbackOutput":3}},"id":"33751931-fbb2-4c25-b9df-9ecbd5af26ea","name":"Switch","type":"n8n-nodes-base.switch","typeVersion":3,"position":[-340,2920]},{"parameters":{"fieldsToSummarize":{"values":[{"aggregation":"concatenate","field":"data"}]},"options":{}},"id":"eeb4a235-3e3a-4641-8665-ee5bdac1c6ee","name":"Summarize1","type":"n8n-nodes-base.summarize","typeVersion":1,"position":[340,2980]},{"parameters":{"options":{}},"id":"70841090-1458-470a-b8c3-03ee3c069da5","name":"Extract from Excel","type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[-20,3060]},{"parameters":{"resource":"fileFolder","returnAll":true,"filter":{"folderId":{"__rl":true,"value":"1rP1DWBKusmnmMLbxcAEy11nlRIpU2a4r","mode":"list","cachedResultName":"Aula nova","cachedResultUrl":"https://drive.google.com/drive/folders/1rP1DWBKusmnmMLbxcAEy11nlRIpU2a4r"}},"options":{"fields":["mimeType","id","name"]}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[-700,2940],"id":"6f31ed8f-979b-450c-b0eb-06453753a3ae","name":"Google Drive","executeOnce":true},{"parameters":{"operation":"delete","tableId":"documents","filters":{"conditions":[{"keyName":"id","condition":"neq","keyValue":"0"}]}},"id":"c860162a-f9c3-4d24-84fb-83c86ceab685","name":"Deleta linhas antigas do documento1","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-880,2940],"alwaysOutputData":true,"executeOnce":false},{"parameters":{"rule":{"interval":[{"triggerAtHour":5}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1040,2760],"id":"1ac2ff57-6625-4a70-adbc-0aa08ed7659a","name":"Schedule Trigger"},{"parameters":{"schema":{"__rl":true,"mode":"list","value":"public"},"table":{"__rl":true,"value":"n8n_chat_histories","mode":"list","cachedResultName":"n8n_chat_histories"},"columns":{"mappingMode":"defineBelow","value":{"session_id":"={{ $('Dados').item.json.Telefone }}","message":"={\"type\": \"human\", \"content\": \"{{ $('Rotas').item.json.message.content.replace(/\\n/g, ' ') }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}"},"matchingColumns":["id"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"number","canBeUsedToMatch":true,"removed":true},{"id":"session_id","displayName":"session_id","required":true,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"message","displayName":"message","required":true,"defaultMatch":false,"display":true,"type":"object","canBeUsedToMatch":true}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[240,1740],"id":"f34691ec-fa29-492e-850e-88cf826fbce1","name":"Salvar Historicoo Humano"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.1,"position":[3180,480],"id":"5a0c45a8-9080-49d6-8c0e-63584c9b199f","name":"When chat message received","webhookId":"af870e9f-98ab-46c8-858d-84fedf8036b2","disabled":true},{"parameters":{"options":{"systemMessage":"={\n  \"name\": \"Amanda\",\n  \"context\": {\n    \"identity\": \"Consultora Comercial de Vendas\",\n    \"business\": \"Fluxo Atendimento por IA para Terapeutas\",\n    \"Language\": \"portugu√™s brasileiro\",\n    \"date\": \"{{ $now.weekdayLong }}, {{ $now.format('dd/MM/yyyy') }}, {{ $now.hour.toString().padStart(2, '0') }}:{{ $now.minute.toString().padStart(2, '0') }}\"\n  },\n  \"Informa√ß√£o atualizada para usar em resposta\": \"{{ $json.output }}\",\n  \"personality\": [\n    \"Fala simples, objetiva e amig√°vel\",\n    \"Tono de voz educado e consultivo\",\n    \"N√£o usa emojis\",\n    \"Fala de forma personalizada, chamando pelo nome se souber\",\n    \"Faz uma pergunta por vez para manter o foco\",\n    \"Cria leve senso de urg√™ncia para agendamento\",\n    \"Refor√ßa benef√≠cios de forma pr√°tica\"\n  ],\n  \"objectives\": [\n    \"Apresentar a solu√ß√£o de atendimento por IA no WhatsApp para terapeutas\",\n    \"Agendar uma reuni√£o comercial com o terapeuta no hor√°rio comercial\"\n  ],\n  \"general_rules\": [\n    \"Atender apenas terapeutas e profissionais da √°rea emocional\",\n    \"Refor√ßar que as reuni√µes s√£o online, r√°pidas e 100% focadas na necessidade do terapeuta\",\n    \"Agendar reuni√µes somente de segunda a sexta-feira em hor√°rio comercial\",\n    \"Caso pe√ßam algo fora do fluxo, gentilmente redirecionar para o agendamento de reuni√£o\",\n    \"Nunca prometer pre√ßo ou condi√ß√µes comerciais sem a reuni√£o\",\n    \"Se a pessoa pedir para falar direto com um humano, informar que a reuni√£o √© o caminho para atendimento personalizado\",\n    \"Evitar termos t√©cnicos como 'chatbot' ou 'automa√ß√£o' e usar sempre 'atendimento inteligente por IA', refor√ßando que o atendimento √© como de uma secret√°ria e n√£o automatizado para agendamentos\",\n    \"Palavras proibidas: rob√¥, autom√°tico, chatbot, gr√°tis\"\n  ],\n  \"flow\": {\n    \"steps\": [\n      {\n        \"step\": \"Perguntar o nome\",\n        \"instructions\": \"Se apresentar e perguntar o nome da pessoa antes de prosseguir\",\n        \"example_message\": \"Ol√°! Meu nome √© Amanda, fa√ßo parte da equipe da Fluxo Atendimento por IA para Terapeutas. Como posso te chamar?\"\n      },\n      {\n        \"step\": \"Confirmar se √© terapeuta\",\n        \"instructions\": \"Ap√≥s receber o nome, confirmar se a pessoa √© terapeuta\",\n        \"example_message\": \"Prazer, Voc√™ √© terapeuta ou atua em outra √°rea da sa√∫de?\"\n      },\n      {\n        \"step\": \"Explica√ß√£o breve da solu√ß√£o\",\n        \"instructions\": \"Se confirmar que √© terapeuta, explicar brevemente o benef√≠cio da solu√ß√£o\",\n        \"example_message\": \"N√≥s ajudamos terapeutas a terem um atendimento inteligente no WhatsApp, como uma secret√°ria virtual que acolhe seus pacientes e organiza a comunica√ß√£o, poupando seu tempo.\"\n      },\n      {\n        \"step\": \"Identificar o maior desafio\",\n        \"instructions\": \"Antes de oferecer reuni√£o, perguntar qual √© o maior desafio atual no atendimento\",\n        \"example_message\": \"Hoje, qual √© o maior desafio que voc√™ enfrenta no seu atendimento? Seria dificuldade para contratar pessoas, agilidade nas respostas, atendimento fora do hor√°rio comercial, ou outra situa√ß√£o?\"\n      },\n      {\n        \"step\": \"Conectar solu√ß√£o √† dor\",\n        \"instructions\": \"Ap√≥s identificar a dor, refor√ßar que a solu√ß√£o pode ajudar especificamente nesse ponto\",\n        \"example_message\": \"Entendo. Nossa solu√ß√£o foi criada exatamente para ajudar terapeutas com essa dificuldade!\"\n      },\n      {\n        \"step\": \"Explica√ß√£o adicional da solu√ß√£o\",\n        \"instructions\": \"Antes de oferecer a reuni√£o, explicar detalhes extras da solu√ß√£o\",\n        \"example_message\": \"Nossa IA entende √°udios enviados pelos seus clientes, interpreta m√∫ltiplas mensagens de texto e, ap√≥s coletar informa√ß√µes sobre o motivo da busca por terapia, ela tamb√©m te notifica em um grupo exclusivo com o nome do potencial cliente e um resumo do seu caso.\"\n      },\n      {\n        \"step\": \"Oferecer agendamento de reuni√£o\",\n        \"instructions\": \"Depois de explicar a funcionalidade, convidar para agendar uma reuni√£o\",\n        \"example_message\": \"Gostaria que eu te mostrasse tudo isso em detalhes numa reuni√£o r√°pida de 30 minutos?\"\n      },\n      {\n        \"step\": \"Agendar reuni√£o\",\n        \"instructions\": \"Se a pessoa demonstrar interesse, pedir para sugerir um dia e um per√≠odo (manh√£ ou tarde)\",\n        \"example_message\": \"Que dia e per√≠odo (manh√£ ou tarde) seria melhor para voc√™? Assim organizamos tudo certinho.\"\n      },\n      {\n        \"step\": \"Confirma√ß√£o de agendamento\",\n        \"instructions\": \"Ap√≥s receber a sugest√£o, informar que um especialista entrar√° em contato para confirmar o hor√°rio certinho e enviar o n√∫mero de protocolo\",\n        \"example_message\": \"Perfeito! Vou pedir para um dos nossos especialistas entrar em contato para confirmar direitinho o hor√°rio com voc√™. Seu n√∫mero de protocolo √© 338201. At√© breve!\"\n      }\n    ]\n  }\n}\n"}},"id":"02ce0ba1-21b8-4403-b29c-c6c4eb956077","name":"Atendente1","type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.6,"position":[3400,480],"disabled":true},{"parameters":{"sessionIdType":"customKey","sessionKey":"16","contextWindowLength":50},"type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","typeVersion":1.3,"position":[3700,600],"id":"08b1a2ad-5ceb-4dde-95de-a863ab4c5d3f","name":"Simple Memory","disabled":true},{"parameters":{"operation":"update","tableId":"dados_cliente","filters":{"conditions":[{"keyName":"telefone","condition":"eq","keyValue":"={{ $('Dados').item.json.Telefone }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"atendimento_ia","fieldValue":"pause"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5720,2360],"id":"fff7177a-c934-418a-87d6-3bc3b6b2dbd5","name":"Pausar IA1"},{"parameters":{"operation":"toBinary","sourceProperty":"base64","options":{"mimeType":"=aplication/pdf"}},"id":"2df7af09-6270-4e49-a31f-516a5b3cc4d9","name":"Converte base 64 para arquivo","type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[800,2280]},{"parameters":{"assignments":{"assignments":[{"id":"4d20037d-7c3f-4a9b-aba2-ae17ed70ed2d","name":"mensagem","value":"={{ $json.body }}","type":"string"}]},"options":{}},"id":"34cf03d1-288e-4078-9b51-abbd72e50ad2","name":"mensagem=documento","type":"n8n-nodes-base.set","typeVersion":3.3,"position":[1100,2280]},{"parameters":{"method":"POST","url":"={{ $('Webhook').item.json.body.server_url }}/chat/getBase64FromMediaMessage/{{ $('Ajuste do n√∫mero de whatsapp').item.json.body.instance }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $('Webhook').item.json.body.apikey }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"message\": {\n        \"key\": {\n            \"id\":  \"{{ $('Webhook').item.json.body.data.key.id }}\"\n        }\n    },\n    \"convertToMp4\": true\n} ","options":{}},"id":"80a71a7e-290b-4cbf-b3cd-c0fca83da5fe","name":"Base64-imagem1","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[660,2280],"retryOnFail":true,"maxTries":2},{"parameters":{"operation":"pdf","options":{}},"type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[960,2280],"id":"e96c7c87-a25d-4bb2-9b06-0abc5d36739c","name":"Extract from File"},{"parameters":{"jsCode":"const rawText = $input.first().json.mensagem || \"\"; // Garante que a string n√£o seja undefined\n\n// 1Ô∏è‚É£ Remover quebras de linha estranhas e normalizar espa√ßos\nlet cleanedText = rawText.replace(/[\\r\\n]+/g, \" \").trim();\n\n// 2Ô∏è‚É£ Remover m√∫ltiplos espa√ßos seguidos\ncleanedText = cleanedText.replace(/\\s{2,}/g, \" \");\n\n// 3Ô∏è‚É£ Corrigir formata√ß√µes comuns\ncleanedText = cleanedText\n  .replace(/\\[Link\\]/g, \"\") // Remove placeholders \"[Link]\"\n  .replace(/mailto:/g, \"\") // Remove \"mailto:\"\n  .replace(/tel:/g, \"\") // Remove \"tel:\"\n  .replace(/‚Ä¢/g, \"-\") // Substitui bullets por \"-\"\n  .replace(/(\\w)\\s+-\\s+(\\w)/g, \"$1 - $2\") // Ajusta formata√ß√£o de datas e t√≠tulos\n  .replace(/https?:\\/\\/\\S+/g, \"\") // Remove links\n  .replace(/\\s*,\\s*/g, \", \") // Normaliza v√≠rgulas e espa√ßos extras\n  .replace(/\\s*-\\s*/g, \" - \") // Ajusta formata√ß√£o de tra√ßos\n  .replace(/^\\s+|\\s+$/g, \"\"); // Remove espa√ßos extras no in√≠cio e no fim\n\n// Retorna o JSON com o nome esperado\nreturn { mensagem: cleanedText };\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1240,2280],"id":"f0b588bb-8401-4d64-8abb-ca780693f1a0","name":"limpa_texto"}],"connections":{"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"buscar_documentos","type":"ai_languageModel","index":0}]]},"Embeddings OpenAI":{"ai_embedding":[[{"node":"Supabase Vector Store","type":"ai_embedding","index":0}]]},"Supabase Vector Store":{"ai_vectorStore":[[{"node":"buscar_documentos","type":"ai_vectorStore","index":0}]]},"OpenAI3":{"ai_languageModel":[[{"node":"Parser  Chain","type":"ai_languageModel","index":0}]]},"Loop Over Items3":{"main":[[],[{"node":"Evolution API","type":"main","index":0}]]},"OutputParser1":{"ai_outputParser":[[{"node":"Parser  Chain","type":"ai_outputParser","index":0}]]},"Parser  Chain":{"main":[[{"node":"Split de Mensagem","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"Atendente","type":"ai_languageModel","index":0}]]},"Atendente":{"main":[[{"node":"Switch2","type":"main","index":0},{"node":"Busca Telefone","type":"main","index":0}]]},"Postgres Chat Memory":{"ai_memory":[[{"node":"Atendente","type":"ai_memory","index":0}]]},"Switch2":{"main":[[{"node":"Parser  Chain","type":"main","index":0}],[{"node":"Evolution API1","type":"main","index":0}]]},"OpenAI Chat Model2":{"ai_languageModel":[[{"node":"Basic LLM Chain1","type":"ai_languageModel","index":0}]]},"Evolution API":{"main":[[{"node":"1 segundo","type":"main","index":0}]]},"Evolution API1":{"main":[[{"node":"ListMessages-Supabase2","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"Cria Hist√≥rico Supabase","type":"main","index":0}]]},"If4":{"main":[[{"node":"Adiciona CHAT supabase","type":"main","index":0}],[{"node":"Atualiza CHAT Supabase","type":"main","index":0}]]},"Busca Telefone":{"main":[[{"node":"If4","type":"main","index":0}]]},"Adiciona CHAT supabase":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Atualiza CHAT Supabase":{"main":[[{"node":"Merge1","type":"main","index":1}]]},"Cria Hist√≥rico Supabase":{"main":[[{"node":"Delete Memory","type":"main","index":0}]]},"Split de Mensagem":{"main":[[{"node":"Loop Over Items3","type":"main","index":0}]]},"1 segundo":{"main":[[{"node":"Loop Over Items3","type":"main","index":0}]]},"buscar_documentos":{"ai_tool":[[{"node":"Agente Rag","type":"ai_tool","index":0}]]},"ListMessages-Supabase2":{"main":[[{"node":"Aggregate2","type":"main","index":0}]]},"Aggregate2":{"main":[[{"node":"Code6","type":"main","index":0}]]},"Code6":{"main":[[{"node":"Basic LLM Chain1","type":"main","index":0}]]},"Basic LLM Chain1":{"main":[[{"node":"Evolution API2","type":"main","index":0}]]},"Evolution API2":{"main":[[{"node":"Pausar IA1","type":"main","index":0}]]},"Supabase":{"main":[[{"node":"If1","type":"main","index":0}]]},"If1":{"main":[[{"node":"Switch6","type":"main","index":0}],[{"node":"Supabase1","type":"main","index":0}]]},"Supabase1":{"main":[[{"node":"Switch6","type":"main","index":0}]]},"Webhook EVO":{"main":[[{"node":"Dados","type":"main","index":0}]]},"Convert to File1":{"main":[[{"node":"OpenAI1","type":"main","index":0}]]},"Edit Fields3":{"main":[[{"node":"Convert to File1","type":"main","index":0}]]},"If3":{"main":[[{"node":"Redis5","type":"main","index":0}],[{"node":"Redis4","type":"main","index":0}]]},"Redis4":{"main":[[{"node":"Get Memory 1","type":"main","index":0}]]},"Redis5":{"main":[[{"node":"Get Memory 1","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Text Memory1","type":"main","index":0}],[{"node":"Text Memory1","type":"main","index":0}],[{"node":"Edit Fields","type":"main","index":0}],[{"node":"Edit Fields3","type":"main","index":0}],[]]},"OpenAI1":{"main":[[{"node":"If3","type":"main","index":0}]]},"Compara Get Memory1":{"main":[[{"node":"Mensagem Completa","type":"main","index":0}]]},"Text Memory1":{"main":[[{"node":"Get Memory 1","type":"main","index":0}]]},"Audio Memory1":{"main":[[{"node":"Get Memory 1","type":"main","index":0}]]},"Edit Fields8":{"main":[[{"node":"Compara Get Memory1","type":"main","index":0}]]},"Wait3":{"main":[[{"node":"Get Memory 2","type":"main","index":0}]]},"Get Memory 1":{"main":[[{"node":"Wait3","type":"main","index":0}]]},"Get Memory 2":{"main":[[{"node":"Edit Fields8","type":"main","index":0}]]},"Switch6":{"main":[[{"node":"Rotas1","type":"main","index":0}],[{"node":"Verificar Pause","type":"main","index":0}]]},"Mensagem Completa":{"main":[[{"node":"Agente Rag","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"OpenAI","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"OpenAI":{"main":[[{"node":"Audio Memory1","type":"main","index":0}]]},"OpenAI Model":{"ai_languageModel":[[{"node":"Agente Treinamento RAG","type":"ai_languageModel","index":0}]]},"Treinamento_feito":{"ai_tool":[[{"node":"Agente Treinamento RAG","type":"ai_tool","index":0}]]},"Character Text Splitter1":{"ai_textSplitter":[[{"node":"Default Data Loader1","type":"ai_textSplitter","index":0}]]},"Aggregate1":{"main":[[{"node":"Summarize1","type":"main","index":0}]]},"Embeddings OpenAI2":{"ai_embedding":[[{"node":"Insert into Supabase Vectorstore1","type":"ai_embedding","index":0}]]},"Default Data Loader1":{"ai_document":[[{"node":"Insert into Supabase Vectorstore1","type":"ai_document","index":0}]]},"Download File1":{"main":[[{"node":"Switch","type":"main","index":0}]]},"Extract from Excel2":{"main":[[{"node":"Aggregate1","type":"main","index":0}]]},"Agente Treinamento RAG":{"main":[[{"node":"Deleta linhas antigas do documento1","type":"main","index":0}]]},"Rotas":{"main":[[],[{"node":"Supabase","type":"main","index":0}],[{"node":"Agente Treinamento RAG","type":"main","index":0}]]},"Pausar IA":{"main":[[{"node":"Salvar Historicoo Humano","type":"main","index":0}]]},"Verificar Pause":{"main":[[{"node":"Rota Atendimento","type":"main","index":0}]]},"Rota Atendimento":{"main":[[{"node":"Switch1","type":"main","index":0}],[{"node":"Salvar Historicoo Humano1","type":"main","index":0}]]},"Rotas1":{"main":[[{"node":"Pausar IA","type":"main","index":0}],[{"node":"Wait","type":"main","index":0}]]},"Reativar IA":{"main":[[{"node":"Salvar Historicoo Humano","type":"main","index":0}]]},"Dados":{"main":[[{"node":"Rotas","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Reativar IA","type":"main","index":0}]]},"OpenAI Chat Model4":{"ai_languageModel":[[{"node":"Agente Rag","type":"ai_languageModel","index":0}]]},"Agente Rag":{"main":[[{"node":"Atendente","type":"main","index":0}]]},"Atualizar_treinamento":{"ai_tool":[[{"node":"Agente Treinamento RAG","type":"ai_tool","index":0}]]},"Switch":{"main":[[{"node":"Extract PDF Text","type":"main","index":0}],[{"node":"Extract from Excel2","type":"main","index":0}],[{"node":"Extract from Excel","type":"main","index":0}],[{"node":"Extract Document Text","type":"main","index":0}]]},"Extract Document Text":{"main":[[{"node":"Insert into Supabase Vectorstore1","type":"main","index":0}]]},"Extract PDF Text":{"main":[[{"node":"Insert into Supabase Vectorstore1","type":"main","index":0}]]},"Summarize1":{"main":[[{"node":"Insert into Supabase Vectorstore1","type":"main","index":0}]]},"Extract from Excel":{"main":[[{"node":"Aggregate1","type":"main","index":0}]]},"Google Drive":{"main":[[{"node":"Download File1","type":"main","index":0}]]},"Deleta linhas antigas do documento1":{"main":[[{"node":"Google Drive","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"Deleta linhas antigas do documento1","type":"main","index":0}]]},"When chat message received":{"main":[[{"node":"Atendente1","type":"main","index":0}]]},"Simple Memory":{"ai_memory":[[{"node":"Atendente1","type":"ai_memory","index":0}]]},"Salvar Historicoo Humano1":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Converte base 64 para arquivo":{"main":[[{"node":"Extract from File","type":"main","index":0}]]},"mensagem=documento":{"main":[[{"node":"limpa_texto","type":"main","index":0}]]},"Base64-imagem1":{"main":[[{"node":"Converte base 64 para arquivo","type":"main","index":0}]]},"Extract from File":{"main":[[{"node":"mensagem=documento","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{"Webhook EVO":[{"json":{"headers":{"host":"webhook.brenoluiz.com","user-agent":"axios/1.7.9","content-length":"952","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"172.18.0.1","x-forwarded-host":"webhook.brenoluiz.com","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"a48f6555c969","x-real-ip":"172.18.0.1"},"params":{},"query":{},"body":{"event":"messages.upsert","instance":"Breno2","data":{"key":{"remoteJid":"553199905686@s.whatsapp.net","fromMe":false,"id":"3EB076C5765248E2104FD0"},"pushName":"Breno Luiz","status":"DELIVERY_ACK","message":{"conversation":"qual √© meu numero de protocolo mesmo ?","messageContextInfo":{"deviceListMetadata":{"senderKeyHash":"uF9ZSLJLccNn9Q==","senderTimestamp":"1745523443","senderAccountType":"E2EE","receiverAccountType":"E2EE","recipientKeyHash":"7Zmo8dM6/NwyLQ==","recipientTimestamp":"1745523475"},"deviceListMetadataVersion":2,"messageSecret":"mtGggzkfRSgy8h41m6BJxDvZe197Ds0P5ZSz5g/OPo4="}},"messageType":"conversation","messageTimestamp":1745623915,"instanceId":"4baef9ca-f39b-450c-a0ad-8ade3fac4486","source":"web"},"destination":"https://webhook.brenoluiz.com/webhook/aula","date_time":"2025-04-25T20:31:55.895Z","sender":"553193673427@s.whatsapp.net","server_url":"https://api.brenoluiz.com","apikey":"DC93469263FD-4FE6-8B66-63D4B0D8461F"},"webhookUrl":"https://webhook.brenoluiz.com/webhook/aula","executionMode":"production"}}],"Agente Rag":[{"json":{"output":"sem dica de resposta"}}]},"versionId":"2364912e-40a9-4d2d-a72f-d5c7e725444b","triggerCount":0,"tags":[]}